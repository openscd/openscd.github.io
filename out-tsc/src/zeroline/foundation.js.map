{"version":3,"file":"foundation.js","sourceRoot":"","sources":["../../../src/zeroline/foundation.ts"],"names":[],"mappings":"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","sourcesContent":["import { css } from 'lit-element';\n\nimport {\n  newActionEvent,\n  isPublic,\n  SCLTag,\n  Wizard,\n  tags,\n} from '../foundation.js';\nimport { emptyWizard, wizards } from '../wizards/wizard-library.js';\n\nimport { BayEditor } from './bay-editor.js';\nimport { SubstationEditor } from './substation-editor.js';\nimport { VoltageLevelEditor } from './voltage-level-editor.js';\n\nfunction containsReference(element: Element, iedName: string): boolean {\n  return Array.from(element.getElementsByTagName('LNode'))\n    .filter(isPublic)\n    .some(lnode => lnode.getAttribute('iedName') === iedName);\n}\n\nfunction isReferencedItself(element: Element, iedName: string): boolean {\n  return (<Element[]>Array.from(element.children)).some(\n    child =>\n      child.tagName === 'LNode' && child.getAttribute('iedName') === iedName\n  );\n}\n\nfunction hasReferencedChildren(element: Element, iedName: string): boolean {\n  const threshold = element.tagName === 'Bay' ? 0 : 1;\n  return (\n    (<Element[]>Array.from(element.children)).filter(child =>\n      containsReference(child, iedName)\n    ).length > threshold\n  );\n}\n\nfunction hasOurs(element: Element, iedName: string): boolean {\n  return Array.from(element.getElementsByTagName('LNode'))\n    .filter(isPublic)\n    .some(lnode => lnode.getAttribute('iedName') === iedName);\n}\n\nfunction getOurs(element: Element, iedName: string): Element[] {\n  return Array.from(element.getElementsByTagName('LNode'))\n    .filter(isPublic)\n    .filter(lnode => lnode.getAttribute('iedName') === iedName);\n}\n\nfunction hasTheirs(element: Element, iedName: string): boolean {\n  const ours = getOurs(element, iedName);\n  const scl = element.closest('SCL')!;\n\n  return Array.from(scl.getElementsByTagName('LNode'))\n    .filter(isPublic)\n    .filter(lnode => lnode.getAttribute('iedName') === iedName)\n    .some(lnode => !ours.includes(lnode));\n}\n\nexport function attachedIeds(\n  element: Element,\n  remainingIeds: Set<Element>\n): Element[] {\n  const attachedIeds: Element[] = [];\n  for (const ied of remainingIeds) {\n    const iedName = ied.getAttribute('name')!;\n\n    if (element.tagName === 'SCL') {\n      if (!hasOurs(element, iedName) || hasReferencedChildren(element, iedName))\n        attachedIeds.push(ied);\n\n      continue;\n    }\n\n    if (hasTheirs(element, iedName)) continue;\n    if (\n      hasReferencedChildren(element, iedName) ||\n      isReferencedItself(element, iedName)\n    )\n      attachedIeds.push(ied);\n  }\n\n  for (const ied of attachedIeds) {\n    remainingIeds.delete(ied);\n  }\n\n  return attachedIeds;\n}\n\nexport function getAttachedIeds(\n  doc: XMLDocument\n): (element: Element) => Element[] {\n  return (element: Element) => {\n    const ieds = new Set(\n      Array.from(doc.querySelectorAll('IED')).filter(isPublic)\n    );\n\n    return attachedIeds(element, ieds);\n  };\n}\n\nexport type ElementEditor = Element & {\n  element: Element;\n};\n\nexport function cloneSubstationElement(\n  editor: BayEditor | VoltageLevelEditor | SubstationEditor\n): void {\n  const element: Element = editor.element;\n  const parent: Element = element.parentElement!;\n  const num = parent.querySelectorAll(\n    `${element.tagName}[name^=\"${element.getAttribute('name') ?? ''}\"]`\n  ).length;\n\n  const clone: Element = <Element>element.cloneNode(true);\n  clone\n    .querySelectorAll('LNode')\n    .forEach(lNode => lNode.parentElement?.removeChild(lNode));\n  // lNode element must be unique within substation -> must be removed\n\n  clone\n    .querySelectorAll('Terminal:not([cNodeName=\"grounded\"])')\n    .forEach(terminal => terminal.parentElement?.removeChild(terminal));\n  // FIXME(JakobVogelsang): for the moment removes terminal as well.\n  // For later terminal keep might be the better choice\n\n  clone\n    .querySelectorAll('ConnectivityNode')\n    .forEach(condNode => condNode.parentElement?.removeChild(condNode));\n  // FIXME(JakobVogelsang): for the moment beeing connectivity node remove as well.\n  // For later connectivity keep might be the better choice to preserve substation structure\n\n  clone.setAttribute('name', element.getAttribute('name')! + num);\n\n  editor.dispatchEvent(\n    newActionEvent({\n      new: {\n        parent: parent,\n        element: clone,\n        reference: element.nextSibling,\n      },\n    })\n  );\n}\n\n/**\n * Moves the element edited by `editor` to the place before the next `Child`\n * editor selected or to the end of the next `Parent` editor selected by mouse\n * click or keyboard (space or enter key).\n *\n * The move action can be aborted by clicking on something other than a `Child`\n * or `Parent` editor or by hitting the escape key on the keyboard.\n */\nexport function startMove<E extends ElementEditor, P extends ElementEditor>(\n  editor: E,\n  Child: new () => E,\n  Parent: new () => P\n): void {\n  if (!editor.element) return;\n\n  editor.classList.add('moving');\n\n  const moveToTarget = (e: MouseEvent | KeyboardEvent) => {\n    if (\n      e instanceof KeyboardEvent &&\n      e.key !== 'Escape' &&\n      e.key !== ' ' &&\n      e.key !== 'Enter'\n    )\n      return;\n\n    e.preventDefault();\n    e.stopImmediatePropagation();\n    editor.classList.remove('moving');\n\n    window.removeEventListener('keydown', moveToTarget, true);\n    window.removeEventListener('click', moveToTarget, true);\n\n    if (e instanceof KeyboardEvent && e.key === 'Escape') return;\n\n    const targetEditor = e\n      .composedPath()\n      .find(e => e instanceof Child || e instanceof Parent);\n\n    if (targetEditor === undefined || targetEditor === editor) return;\n\n    const destination =\n      targetEditor instanceof Child\n        ? {\n            parent: targetEditor.element.parentElement!,\n            reference: targetEditor.element,\n          }\n        : { parent: (<P>targetEditor).element, reference: null };\n\n    if (!destination.parent) return;\n\n    if (\n      editor.element.parentElement !== destination.parent ||\n      editor.element.nextElementSibling !== destination.reference\n    )\n      editor.dispatchEvent(\n        newActionEvent({\n          old: {\n            element: editor.element,\n            parent: editor.element.parentElement!,\n            reference: editor.element.nextSibling,\n          },\n          new: destination,\n        })\n      );\n  };\n\n  window.addEventListener('click', moveToTarget, true);\n  window.addEventListener('keydown', moveToTarget, true);\n}\n\n// Substation element hierarchy\nconst substationPath = [\n  ':root',\n  'Substation',\n  'VoltageLevel',\n  'Bay',\n  'ConductingEquipment',\n];\n\nexport type SubstationTag =\n  | 'Substation'\n  | 'VoltageLevel'\n  | 'Bay'\n  | 'ConductingEquipment';\n\n/** `Private`-safeguarded selectors for `Substation` and its descendants */\nexport const selectors = <Record<SubstationTag, string>>(\n  Object.fromEntries(\n    substationPath.map((e, i, a) => [e, a.slice(0, i + 1).join(' > ')])\n  )\n);\n\n/** Common `CSS` styles used by substation subeditors */\nexport const styles = css`\n  abbr {\n    text-decoration: none;\n    border-bottom: none;\n  }\n\n  #iedcontainer {\n    display: grid;\n    grid-gap: 12px;\n    padding: 8px 12px 16px;\n    box-sizing: border-box;\n    grid-template-columns: repeat(auto-fit, minmax(64px, auto));\n  }\n`;\n"]}