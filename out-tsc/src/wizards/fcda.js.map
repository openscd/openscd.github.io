{"version":3,"file":"fcda.js","sourceRoot":"","sources":["../../../src/wizards/fcda.ts"],"names":[],"mappings":"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","sourcesContent":["import { html } from 'lit-element';\nimport { get, translate } from 'lit-translate';\n\nimport {\n  createElement,\n  identity,\n  selector,\n  Wizard,\n  WizardAction,\n  WizardActor,\n  WizardInput,\n} from '../foundation.js';\nimport { getChildren } from './foundation/functions.js';\n\nimport { Directory, FinderList } from '../finder-list.js';\n\nfunction newFCDA(parent: Element, path: string[]): Element | undefined {\n  const [leafTag, leafId] = path[path.length - 1].split(': ');\n  const leaf = parent.ownerDocument.querySelector(selector(leafTag, leafId));\n  if (!leaf || getChildren(leaf).length > 0) return;\n\n  const lnSegment = path.find(segment => segment.startsWith('LN'));\n  if (!lnSegment) return;\n\n  const [lnTag, lnId] = lnSegment.split(': ');\n\n  const ln = parent.ownerDocument.querySelector(selector(lnTag, lnId));\n  if (!ln) return;\n\n  const iedName = ln.closest('IED')?.getAttribute('name');\n  const ldInst = ln.closest('LDevice')?.getAttribute('inst');\n  const prefix = ln.getAttribute('prefix') ?? '';\n  const lnClass = ln.getAttribute('lnClass');\n  const lnInst = ln.getAttribute('inst') ?? '';\n\n  let doName = '';\n  let daName = '';\n  let fc = '';\n\n  for (const segment of path) {\n    const [tagName, id] = segment.split(': ');\n    if (!['DO', 'DA', 'SDO', 'BDA'].includes(tagName)) continue;\n\n    const element = parent.ownerDocument.querySelector(selector(tagName, id));\n\n    if (!element) return;\n\n    const name = element.getAttribute('name')!;\n\n    if (tagName === 'DO') doName = name;\n    if (tagName === 'SDO') doName = doName + '.' + name;\n    if (tagName === 'DA') {\n      daName = name;\n      fc = element.getAttribute('fc') ?? '';\n    }\n    if (tagName === 'BDA') daName = daName + '.' + name;\n  }\n\n  if (!iedName || !ldInst || !lnClass || !doName || !daName || !fc) return;\n\n  return createElement(parent.ownerDocument, 'FCDA', {\n    iedName,\n    ldInst,\n    prefix,\n    lnClass,\n    lnInst,\n    doName,\n    daName,\n    fc,\n  });\n}\n\nfunction createFCDAsAction(parent: Element): WizardActor {\n  return (inputs: WizardInput[], wizard: Element): WizardAction[] => {\n    const finder = wizard.shadowRoot!.querySelector<FinderList>('finder-list');\n    const paths = finder?.paths ?? [];\n\n    const actions = [];\n    for (const path of paths) {\n      const element = newFCDA(parent, path);\n\n      if (!element) continue;\n\n      actions.push({\n        new: {\n          parent,\n          element,\n          reference: null,\n        },\n      });\n    }\n\n    return actions;\n  };\n}\n\nfunction getDisplayString(entry: string): string {\n  return entry.replace(/^.*>/, '').trim();\n}\n\nfunction getReader(server: Element): (path: string[]) => Promise<Directory> {\n  return async (path: string[]) => {\n    const [tagName, id] = path[path.length - 1]?.split(': ', 2);\n    const element = server.ownerDocument.querySelector(selector(tagName, id));\n\n    if (!element)\n      return { path, header: html`<p>${translate('error')}</p>`, entries: [] };\n\n    return {\n      path,\n      header: undefined,\n      entries: getChildren(element).map(\n        child => `${child.tagName}: ${identity(child)}`\n      ),\n    };\n  };\n}\n\nexport function createFCDAsWizard(parent: Element): Wizard | undefined {\n  const server = parent.closest('Server');\n  if (!server) return;\n\n  return [\n    {\n      title: get('wizard.title.add', { tagName: 'FCDA' }),\n      primary: {\n        label: 'add',\n        icon: 'add',\n        action: createFCDAsAction(parent),\n      },\n      content: [\n        html`<finder-list\n          multi\n          .paths=${[['Server: ' + identity(server)]]}\n          .read=${getReader(server)}\n          .getDisplayString=${getDisplayString}\n          .getTitle=${(path: string[]) => path[path.length - 1]}\n        ></finder-list>`,\n      ],\n    },\n  ];\n}\n"]}