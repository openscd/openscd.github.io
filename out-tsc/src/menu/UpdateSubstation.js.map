{"version":3,"file":"UpdateSubstation.js","sourceRoot":"","sources":["../../../src/menu/UpdateSubstation.ts"],"names":[],"mappings":"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","sourcesContent":["import { css, html, LitElement, query, TemplateResult } from 'lit-element';\nimport { get } from 'lit-translate';\n\nimport {\n  crossProduct,\n  identity,\n  newWizardEvent,\n  SCLTag,\n  selector,\n  tags,\n} from '../foundation.js';\nimport { Diff, mergeWizard } from '../wizards.js';\n\nexport function isValidReference(\n  doc: XMLDocument,\n  identity: string | number\n): boolean {\n  if (typeof identity !== 'string') return false;\n  const [iedName, ldInst, prefix, lnClass, lnInst] = identity.split(/[ /]/);\n\n  if (!iedName || !lnClass) return false;\n\n  if (ldInst === '(Client)') {\n    const [\n      iedNameSelectors,\n      prefixSelectors,\n      lnClassSelectors,\n      lnInstSelectors,\n    ] = [\n      [`IED[name=\"${iedName}\"]`],\n      prefix ? [`[prefix=\"${prefix}\"]`] : [':not([prefix])', '[prefix=\"\"]'],\n      [`LN[lnClass=\"${lnClass}\"]`],\n      lnInst ? [`[inst=\"${lnInst}\"]`] : [':not([inst])', '[inst=\"\"]'],\n    ];\n\n    return (\n      doc.querySelector(\n        crossProduct(\n          iedNameSelectors,\n          ['>AccessPoint>'],\n          lnClassSelectors,\n          prefixSelectors,\n          lnInstSelectors\n        )\n          .map(strings => strings.join(''))\n          .join(',')\n      ) !== null\n    );\n  }\n\n  const [\n    iedNameSelectors,\n    ldInstSelectors,\n    prefixSelectors,\n    lnClassSelectors,\n    lnInstSelectors,\n  ] = [\n    [`IED[name=\"${iedName}\"]`],\n    [`LDevice[inst=\"${ldInst}\"]`],\n    prefix ? [`[prefix=\"${prefix}\"]`] : [':not([prefix])', '[prefix=\"\"]'],\n    lnClass === 'LLN0' ? [`LN0`] : [`LN[lnClass=\"${lnClass}\"]`],\n    lnInst ? [`[inst=\"${lnInst}\"]`] : [':not([inst])', '[inst=\"\"]'],\n  ];\n\n  return (\n    doc.querySelector(\n      crossProduct(\n        iedNameSelectors,\n        [' '],\n        ldInstSelectors,\n        ['>'],\n        lnClassSelectors,\n        prefixSelectors,\n        lnInstSelectors\n      )\n        .map(strings => strings.join(''))\n        .join(',')\n    ) !== null\n  );\n}\n\nexport default class UpdateSubstationPlugin extends LitElement {\n  doc!: XMLDocument;\n\n  @query('#update-substation-plugin-input') pluginFileUI!: HTMLInputElement;\n\n  updateSubstation(event: Event): void {\n    const file =\n      (<HTMLInputElement | null>event.target)?.files?.item(0) ?? false;\n    if (file)\n      file.text().then(text => {\n        const doc = new DOMParser().parseFromString(text, 'application/xml');\n        // FIXME: Dirty hack should not be necessary!\n        document.querySelector('open-scd')!.dispatchEvent(\n          newWizardEvent(\n            mergeWizard(\n              // FIXME: doesn't work with multiple Substations!\n              this.doc.documentElement,\n              doc.documentElement,\n              {\n                title: get('updatesubstation.title'),\n                selected: (diff: Diff<Element | string>): boolean =>\n                  diff.theirs instanceof Element\n                    ? diff.theirs.tagName === 'LNode'\n                      ? this.doc.querySelector(\n                          selector('LNode', identity(diff.theirs))\n                        ) === null &&\n                        isValidReference(doc, identity(diff.theirs))\n                      : diff.theirs.tagName === 'Substation' ||\n                        !tags['SCL'].children.includes(\n                          <SCLTag>diff.theirs.tagName\n                        )\n                    : diff.theirs !== null,\n                disabled: (diff: Diff<Element | string>): boolean =>\n                  diff.theirs instanceof Element &&\n                  diff.theirs.tagName === 'LNode' &&\n                  (this.doc.querySelector(\n                    selector('LNode', identity(diff.theirs))\n                  ) !== null ||\n                    !isValidReference(doc, identity(diff.theirs))),\n                auto: (): boolean => true,\n              }\n            )\n          )\n        );\n      });\n    this.pluginFileUI.onchange = null;\n  }\n\n  async run(): Promise<void> {\n    this.pluginFileUI.click();\n  }\n\n  render(): TemplateResult {\n    return html`<input @click=${(event: MouseEvent) =>\n      ((<HTMLInputElement>event.target).value = '')} @change=${(e: Event) =>\n      this.updateSubstation(\n        e\n      )} id=\"update-substation-plugin-input\" accept=\".sed,.scd,.ssd,.iid,.cid\" type=\"file\"></input>`;\n  }\n\n  static styles = css`\n    input {\n      width: 0;\n      height: 0;\n      opacity: 0;\n    }\n  `;\n}\n"]}