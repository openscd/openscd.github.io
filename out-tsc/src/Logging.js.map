{"version":3,"file":"Logging.js","sourceRoot":"","sources":["../../src/Logging.ts"],"names":[],"mappings":";AAAA,OAAO,EACL,IAAI,EACJ,gBAAgB,EAChB,QAAQ,EACR,KAAK,GAEN,MAAM,aAAa,CAAC;AACrB,OAAO,EAAE,SAAS,EAAE,MAAM,gCAAgC,CAAC;AAK3D,OAAO,EAEL,aAAa,EACb,MAAM,EAQN,cAAc,GAGf,MAAM,iBAAiB,CAAC;AACzB,OAAO,EAAE,GAAG,EAAE,SAAS,EAAE,MAAM,eAAe,CAAC;AAC/C,OAAO,EAAE,aAAa,EAAE,UAAU,EAAE,MAAM,YAAY,CAAC;AAGvD,MAAM,KAAK,GAAG;IACZ,IAAI,EAAE,MAAM;IACZ,OAAO,EAAE,SAAS;IAClB,KAAK,EAAE,QAAQ;IACf,MAAM,EAAE,SAAS;IACjB,UAAU,EAAE,oBAAoB;CACjC,CAAC;AAEF,SAAS,aAAa,CAAC,GAAW;IAChC,MAAM,MAAM,GAAW,CACrB,IAAI,CAAC,KAAK,CAAC,YAAY,CAAC,OAAO,CAAC,SAAS,CAAC,IAAI,IAAI,CAAC,CAAC,IAAI,CACtD,CAAC,CAAS,EAAE,EAAE,CAAC,CAAC,CAAC,GAAG,KAAK,GAAG,CAC7B,CACF,CAAC;IACF,IAAI,CAAC,MAAM;QAAE,OAAO,GAAG,CAAC;IAExB,MAAM,IAAI,GAAG,MAAM,CAAC,IAAI,CAAC;IACzB,OAAO,IAAI,IAAI,GAAG,CAAC;AACrB,CAAC;AAeD,MAAM,UAAU,OAAO,CAAsC,IAAW;IACtE,MAAM,cAAe,SAAQ,IAAI;QAwK/B,YAAY,GAAG,IAAW;YACxB,KAAK,CAAC,GAAG,IAAI,CAAC,CAAC;YAxKjB,mEAAmE;YAEnE,YAAO,GAAe,EAAE,CAAC;YACzB,oDAAoD;YAEpD,kBAAa,GAAG,CAAC,CAAC,CAAC;YAEnB,cAAS,GAAG,IAAI,GAAG,EAAyB,CAAC;YAmK3C,IAAI,CAAC,IAAI,GAAG,IAAI,CAAC,IAAI,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;YACjC,IAAI,CAAC,IAAI,GAAG,IAAI,CAAC,IAAI,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;YAEjC,IAAI,CAAC,KAAK,GAAG,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;YACnC,IAAI,CAAC,gBAAgB,CAAC,KAAK,EAAE,IAAI,CAAC,KAAK,CAAC,CAAC;YACzC,IAAI,CAAC,gBAAgB,CAAC,OAAO,EAAE,IAAI,CAAC,OAAO,CAAC,CAAC;YAC7C,IAAI,CAAC,gBAAgB,CAAC,UAAU,EAAE,IAAI,CAAC,oBAAoB,CAAC,CAAC;QAC/D,CAAC;QA/JD,IAAI,OAAO;YACT,OAAO,IAAI,CAAC,aAAa,IAAI,CAAC,CAAC;QACjC,CAAC;QACD,IAAI,OAAO;YACT,OAAO,IAAI,CAAC,UAAU,IAAI,CAAC,CAAC;QAC9B,CAAC;QAED,IAAI,cAAc;YAChB,IAAI,CAAC,IAAI,CAAC,OAAO;gBAAE,OAAO,CAAC,CAAC,CAAC;YAC7B,OAAO,IAAI,CAAC,OAAO;iBAChB,KAAK,CAAC,CAAC,EAAE,IAAI,CAAC,aAAa,CAAC;iBAC5B,GAAG,CAAC,KAAK,CAAC,EAAE,CAAC,CAAC,KAAK,CAAC,IAAI,IAAI,QAAQ,CAAC,CAAC,CAAC,IAAI,CAAC,CAAC,CAAC,KAAK,CAAC,CAAC;iBACrD,WAAW,CAAC,IAAI,CAAC,CAAC;QACvB,CAAC;QACD,IAAI,UAAU;YACZ,IAAI,KAAK,GAAG,IAAI,CAAC,OAAO;iBACrB,KAAK,CAAC,IAAI,CAAC,aAAa,GAAG,CAAC,CAAC;iBAC7B,SAAS,CAAC,KAAK,CAAC,EAAE,CAAC,KAAK,CAAC,IAAI,IAAI,QAAQ,CAAC,CAAC;YAC9C,IAAI,KAAK,IAAI,CAAC;gBAAE,KAAK,IAAI,IAAI,CAAC,aAAa,GAAG,CAAC,CAAC;YAChD,OAAO,KAAK,CAAC;QACf,CAAC;QAEO,aAAa,CAAC,IAAmB;YACvC,MAAM,aAAa,GAAG,IAAI,IAAI,CAAC,IAAI,IAAI,EAAE,CAAC,CAAC;YAC3C,IAAI,CAAC,KAAK,CAAC,aAAa,CAAC,OAAO,EAAE,CAAC,EAAE;gBACnC,OAAO,aAAa,CAAC;aACtB;YACD,OAAO,IAAI,CAAC;QACd,CAAC;QAEO,aAAa,CACnB,GAAkB,EAClB,GAAkB;YAElB,IAAI,OAAO,GAAG,GAAG,CAAC;YAClB,IAAI,OAAO,KAAK,IAAI,IAAI,GAAG,KAAK,IAAI,EAAE;gBACpC,OAAO,IAAI,KAAK,GAAG,GAAG,CAAC;aACxB;iBAAM,IAAI,GAAG,KAAK,IAAI,EAAE;gBACvB,OAAO,GAAG,GAAG,CAAC;aACf;YACD,OAAO,OAAO,IAAI,SAAS,CAAC;QAC9B,CAAC;QAEO,qBAAqB,CAC3B,GAAkB,EAClB,IAAmB,EACnB,GAAkB,EAClB,IAAmB;YAEnB,OAAO;gBACL,IAAI,EAAE,YAAY;gBAClB,KAAK,EAAE,IAAI,IAAI,WAAW;gBAC1B,OAAO,EAAE,IAAI,CAAC,aAAa,CAAC,GAAG,EAAE,GAAG,CAAC;gBACrC,IAAI,EAAE,IAAI,CAAC,aAAa,CAAC,IAAI,CAAC;aAC/B,CAAC;QACJ,CAAC;QAEO,KAAK,CAAC,oBAAoB,CAAC,KAAmB;YACpD,MAAM,GAAG,GAAG,KAAK,CAAC,MAAM,CAAC,GAAG,CAAC;YAE7B,KAAK,CAAC,IAAI,CACR,GAAG,CAAC,gBAAgB,CAAC,kCAAkC,CAAC,CACzD,CAAC,OAAO,CAAC,WAAW,CAAC,EAAE;gBACtB,IAAI,CAAC,OAAO,CAAC,IAAI,CACf,IAAI,CAAC,qBAAqB,CACxB,WAAW,CAAC,YAAY,CAAC,KAAK,CAAC,EAC/B,WAAW,CAAC,YAAY,CAAC,MAAM,CAAC,EAChC,WAAW,CAAC,YAAY,CAAC,KAAK,CAAC,EAC/B,WAAW,CAAC,YAAY,CAAC,MAAM,CAAC,CACjC,CACF,CAAC;YACJ,CAAC,CAAC,CAAC;QACL,CAAC;QAEO,OAAO,CAAC,EAAc;YAC5B,MAAM,MAAM,GAAG,IAAI,CAAC,SAAS,CAAC,GAAG,CAAC,EAAE,CAAC,MAAM,CAAC,WAAW,CAAC,CAAC;YAEzD,IAAI,CAAC,MAAM;gBAAE,IAAI,CAAC,SAAS,CAAC,GAAG,CAAC,EAAE,CAAC,MAAM,CAAC,WAAW,EAAE,CAAC,EAAE,CAAC,MAAM,CAAC,CAAC,CAAC;;gBAC/D,MAAM,EAAE,IAAI,CAAC,EAAE,CAAC,MAAM,CAAC,CAAC;YAE7B,IAAI,CAAC,WAAW,GAAG,EAAE,CAAC,MAAM,CAAC;YAC7B,IAAI,CAAC,OAAO,CAAC,KAAK,EAAE,CAAC;YACrB,IAAI,CAAC,OAAO,CAAC,IAAI,EAAE,CAAC;QACtB,CAAC;QAED,IAAI;YACF,IAAI,CAAC,IAAI,CAAC,OAAO;gBAAE,OAAO,KAAK,CAAC;YAChC,IAAI,CAAC,aAAa,CAChB,cAAc,CACZ,MAAM,CAAe,IAAI,CAAC,OAAO,CAAC,IAAI,CAAC,aAAa,CAAE,CAAC,MAAM,CAAC,CAC/D,CACF,CAAC;YACF,IAAI,CAAC,aAAa,GAAG,IAAI,CAAC,cAAc,CAAC;YACzC,OAAO,IAAI,CAAC;QACd,CAAC;QACD,IAAI;YACF,IAAI,CAAC,IAAI,CAAC,OAAO;gBAAE,OAAO,KAAK,CAAC;YAChC,IAAI,CAAC,aAAa,CAChB,cAAc,CAAe,IAAI,CAAC,OAAO,CAAC,IAAI,CAAC,UAAU,CAAE,CAAC,MAAM,CAAC,CACpE,CAAC;YACF,IAAI,CAAC,aAAa,GAAG,IAAI,CAAC,UAAU,CAAC;YACrC,OAAO,IAAI,CAAC;QACd,CAAC;QAEO,KAAK,CAAC,EAAY;YACxB,IAAI,EAAE,CAAC,MAAM,CAAC,IAAI,KAAK,OAAO,EAAE;gBAC9B,IAAI,CAAC,OAAO,GAAG,EAAE,CAAC;gBAClB,IAAI,CAAC,aAAa,GAAG,CAAC,CAAC,CAAC;gBACxB,OAAO;aACR;YAED,MAAM,KAAK,GAAa;gBACtB,IAAI,EAAE,IAAI,IAAI,EAAE;gBAChB,GAAG,EAAE,CAAC,MAAM;aACb,CAAC;YAEF,IAAI,KAAK,CAAC,IAAI,KAAK,QAAQ,EAAE;gBAC3B,IAAI,KAAK,CAAC,MAAM,CAAC,OAAO;oBAAE,OAAO;gBACjC,KAAK,CAAC,MAAM,CAAC,OAAO,GAAG,IAAI,CAAC;gBAC5B,IAAI,IAAI,CAAC,UAAU,KAAK,CAAC,CAAC;oBAAE,IAAI,CAAC,OAAO,CAAC,MAAM,CAAC,IAAI,CAAC,UAAU,CAAC,CAAC;gBACjE,IAAI,CAAC,aAAa,GAAG,IAAI,CAAC,OAAO,CAAC,MAAM,CAAC;aAC1C;YAED,IAAI,CAAC,OAAO,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC;YACzB,IAAI,CAAC,IAAI,CAAC,KAAK,CAAC,IAAI,EAAE;gBACpB,MAAM,EAAE,GAAG;oBACT,KAAK,EAAE,IAAI,CAAC,OAAO;oBACnB,OAAO,EAAE,IAAI,CAAC,SAAS;oBACvB,IAAI,EAAE,IAAI,CAAC,MAAM;oBACjB,MAAM,EAAE,IAAI,CAAC,MAAM;iBACpB,CAAC,EAAE,CAAC,MAAM,CAAC,IAAI,CAAC,CAAC;gBAElB,EAAE,CAAC,KAAK,EAAE,CAAC;gBACX,EAAE,CAAC,IAAI,EAAE,CAAC;aACX;YACD,IAAI,EAAE,CAAC,MAAM,CAAC,IAAI,IAAI,OAAO,EAAE;gBAC7B,IAAI,CAAC,OAAO,CAAC,KAAK,EAAE,CAAC,CAAC,wBAAwB;gBAC9C,IAAI,CAAC,OAAO,CAAC,IAAI,EAAE,CAAC;aACrB;YACD,IAAI,CAAC,aAAa,CAAC,SAAS,EAAE,EAAE,CAAC,CAAC;QACpC,CAAC;QAED,KAAK,CAAC,aAAa;YACjB,MAAM,IAAI,OAAO,CAAO,OAAO,CAAC,EAAE,CAChC,qBAAqB,CAAC,GAAG,EAAE,CAAC,OAAO,EAAE,CAAC,CACvC,CAAC;YACF,KAAK,CAAC,aAAa,EAAE,CAAC;QACxB,CAAC;QAcD,cAAc,CACZ,KAAe,EACf,KAAa,EACb,OAAmB;YAEnB,OAAO,IAAI,CAAA,iBAAiB,KAAK,CAAC,KAAK;;mBAE1B,KAAK,CAAC,IAAI;;qBAER,CAAC,CAAC,KAAK,CAAC,OAAO;uBACb,IAAI,CAAC,aAAa,IAAI,OAAO,CAAC,MAAM,GAAG,KAAK,GAAG,CAAC;;;;kBAIrD,KAAK,CAAC,IAAI,EAAE,cAAc,EAAE;cAChC,KAAK,CAAC,KAAK;;mCAEU,KAAK,CAAC,OAAO;;;6DAGa,SAAS,CACxD,UAAU,CAAC,KAAK,CAAC,IAAI,CAAC,CACvB;eACE,KAAK,CAAC,KAAK,CAAC,IAAI,CAAC;;;QAGxB,CAAC;QACL,CAAC;QAEO,aAAa;YACnB,IAAI,IAAI,CAAC,OAAO,CAAC,MAAM,GAAG,CAAC;gBACzB,OAAO,IAAI,CAAC,OAAO,CAAC,KAAK,EAAE,CAAC,OAAO,EAAE,CAAC,GAAG,CAAC,IAAI,CAAC,cAAc,EAAE,IAAI,CAAC,CAAC;;gBAErE,OAAO,IAAI,CAAA;kBACD,SAAS,CAAC,iBAAiB,CAAC;;yBAErB,CAAC;QACtB,CAAC;QAEO,gBAAgB,CAAC,KAAkB;YACzC,OAAO,IAAI,CAAA,iBAAiB,KAAK,CAAC,KAAK,GAAG,IAAI,GAAG,KAAK,CAAC,OAAO;mCACjC,CAAC,CAAC,KAAK,CAAC,OAAO;mBAC/B,KAAK,CAAC,KAAK;mCACK,KAAK,CAAC,OAAO;;QAExC,CAAC;QACL,CAAC;QAED,sBAAsB,CAAC,MAAqB;YAC1C,IAAI,MAAM,CAAC,MAAM,KAAK,CAAC;gBAAE,OAAO,CAAC,IAAI,CAAA,EAAE,CAAC,CAAC;YACzC,OAAO;gBACL,IAAI,CAAA;aACC,aAAa,CAAC,MAAM,CAAC,CAAC,CAAC,CAAC,WAAW,CAAC;UACvC;gBACF,IAAI,CAAA,2CAA2C;gBAC/C,GAAG,MAAM,CAAC,GAAG,CAAC,KAAK,CAAC,EAAE,CAAC,IAAI,CAAC,gBAAgB,CAAC,KAAK,CAAC,CAAC;aACrD,CAAC;QACJ,CAAC;QAEO,YAAY;YAClB,MAAM,UAAU,GAAqB,EAAE,CAAC;YAExC,IAAI,CAAC,SAAS,CAAC,OAAO,CAAC,MAAM,CAAC,EAAE;gBAC9B,IAAI,CAAC,sBAAsB,CAAC,MAAM,CAAC,CAAC,OAAO,CAAC,SAAS,CAAC,EAAE,CACtD,UAAU,CAAC,IAAI,CAAC,SAAS,CAAC,CAC3B,CAAC;YACJ,CAAC,CAAC,CAAC;YAEH,OAAO,UAAU,CAAC,MAAM;gBACtB,CAAC,CAAC,UAAU;gBACZ,CAAC,CAAC,IAAI,CAAA;oBACM,SAAS,CAAC,kBAAkB,CAAC;;2BAEtB,CAAC;QACxB,CAAC;QAEO,mBAAmB;YACzB,OAAwB,MAAM,CAAC,IAAI,CAAC,KAAK,CAAE,CAAC,GAAG,CAC7C,IAAI,CAAC,EAAE,CAAC,IAAI,CAAA;gBACJ,IAAI;gBACJ,IAAI,KAAK,YAAY;aACxB,aAAa,CAAC,IAAI,EAAE,KAAK,CAAC;YAC3B,aAAa,CAAC,IAAI,EAAE,IAAI,CAAC;UAC3B,CACH,CAAC;QACJ,CAAC;QAED,MAAM;YACJ,OAAO,IAAI,CAAA,GAAG,aAAa,CAAC,KAAK,CAAC,MAAM,EAAE,CAAC;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;wCAoDT,SAAS,CAAC,UAAU,CAAC;YACjD,IAAI,CAAC,mBAAmB,EAAE;6CACO,IAAI,CAAC,aAAa,EAAE;;;qBAG5C,SAAS,CAAC,MAAM,CAAC;wBACd,CAAC,IAAI,CAAC,OAAO;qBAChB,IAAI,CAAC,IAAI;;;;;qBAKT,SAAS,CAAC,MAAM,CAAC;wBACd,CAAC,IAAI,CAAC,OAAO;qBAChB,IAAI,CAAC,IAAI;;;;eAIf,SAAS,CAAC,OAAO,CAAC;;;;+CAIc,SAAS,CAAC,WAAW,CAAC;;eAEtD,IAAI,CAAC,YAAY,EAAE;;;eAGnB,SAAS,CAAC,OAAO,CAAC;;;;;;;uBAOV,IAAI,CAAC,OAAO;iBACtB,KAAK,EAAE;iBACP,OAAO,EAAE;iBACT,IAAI,CAAC,EAAE,CAAC,EAAE,CAAC,EAAE,CAAC,IAAI,KAAK,MAAM,IAAI,EAAE,CAAC,IAAI,KAAK,QAAQ,CAAC,EAAE,KAAK;gBAChE,GAAG,CAAC,0BAA0B,CAAC;;;;;;;uBAOlB,IAAI,CAAC,OAAO;iBACtB,KAAK,EAAE;iBACP,OAAO,EAAE;iBACT,IAAI,CAAC,EAAE,CAAC,EAAE,CAAC,EAAE,CAAC,IAAI,KAAK,SAAS,CAAC,EAAE,KAAK;gBAC3C,GAAG,CAAC,0BAA0B,CAAC;;;;;qBAKpB,GAAG,EAAE,CAAC,IAAI,CAAC,KAAK,CAAC,IAAI,EAAE;eAC7B,SAAS,CAAC,mBAAmB,CAAC;;;;;;;uBAOtB,IAAI,CAAC,OAAO;iBACtB,KAAK,EAAE;iBACP,OAAO,EAAE;iBACT,IAAI,CAAC,EAAE,CAAC,EAAE,CAAC,EAAE,CAAC,IAAI,KAAK,OAAO,CAAC,EAAE,KAAK;gBACzC,GAAG,CAAC,0BAA0B,CAAC;;;;;qBAKpB,GAAG,EAAE,CAAC,IAAI,CAAC,KAAK,CAAC,IAAI,EAAE;eAC7B,SAAS,CAAC,mBAAmB,CAAC;;;;;;;uBAOtB,IAAI,CAAC,WAAW,EAAE,KAAK;gBACpC,GAAG,CAAC,0BAA0B,CAAC;;;;;qBAKpB,GAAG,EAAE,CAAC,IAAI,CAAC,YAAY,CAAC,IAAI,EAAE;eACpC,SAAS,CAAC,mBAAmB,CAAC;;;wBAGrB,CAAC;QACrB,CAAC;KACF;IAxZC;QADC,QAAQ,CAAC,EAAE,IAAI,EAAE,KAAK,EAAE,CAAC;mDACD;IAGzB;QADC,QAAQ,CAAC,EAAE,IAAI,EAAE,MAAM,EAAE,CAAC;yDACR;IAEnB;QADC,QAAQ,EAAE;qDACkC;IAE7C;QADC,gBAAgB,EAAE;uDACO;IAEX;QAAd,KAAK,CAAC,MAAM,CAAC;iDAAgB;IACR;QAArB,KAAK,CAAC,aAAa,CAAC;wDAAuB;IAC3B;QAAhB,KAAK,CAAC,QAAQ,CAAC;mDAAoB;IACjB;QAAlB,KAAK,CAAC,UAAU,CAAC;qDAAsB;IACxB;QAAf,KAAK,CAAC,OAAO,CAAC;kDAAmB;IACjB;QAAhB,KAAK,CAAC,QAAQ,CAAC;mDAAoB;IA4YtC,OAAO,cAAc,CAAC;AACxB,CAAC","sourcesContent":["import {\n  html,\n  internalProperty,\n  property,\n  query,\n  TemplateResult,\n} from 'lit-element';\nimport { ifDefined } from 'lit-html/directives/if-defined';\n\nimport { Dialog } from '@material/mwc-dialog';\nimport { Snackbar } from '@material/mwc-snackbar';\n\nimport {\n  CommitEntry,\n  ifImplemented,\n  invert,\n  IssueDetail,\n  IssueEvent,\n  LitElementConstructor,\n  LogEntry,\n  LogEntryType,\n  LogEvent,\n  Mixin,\n  newActionEvent,\n  OpenDocEvent,\n  SclhistoryEntry,\n} from './foundation.js';\nimport { get, translate } from 'lit-translate';\nimport { getFilterIcon, iconColors } from './icons.js';\nimport { Plugin } from './Plugging.js';\n\nconst icons = {\n  info: 'info',\n  warning: 'warning',\n  error: 'report',\n  action: 'history',\n  sclhistory: 'history_toggle_off',\n};\n\nfunction getPluginName(src: string): string {\n  const plugin = <Plugin>(\n    JSON.parse(localStorage.getItem('plugins') ?? '[]').find(\n      (p: Plugin) => p.src === src\n    )\n  );\n  if (!plugin) return src;\n\n  const name = plugin.name;\n  return name || src;\n}\n\n/**\n * A mixin adding a `history` property to any `LitElement`, in which\n * incoming [[`LogEvent`]]s are logged.\n *\n * For [[`EditorAction`]] entries, also sets `currentAction` to the index of\n * the committed action, allowing the user to go to `previousAction` with\n * `undo()` if `canUndo` and to go to `nextAction` with `redo()` if `canRedo`.\n *\n * Renders the `history` to `logUI` and the latest `'error'` [[`LogEntry`]] to\n * `messageUI`.\n */\nexport type LoggingElement = Mixin<typeof Logging>;\n\nexport function Logging<TBase extends LitElementConstructor>(Base: TBase) {\n  class LoggingElement extends Base {\n    /** All [[`LogEntry`]]s received so far through [[`LogEvent`]]s. */\n    @property({ type: Array })\n    history: LogEntry[] = [];\n    /** Index of the last [[`EditorAction`]] applied. */\n    @property({ type: Number })\n    currentAction = -1;\n    @property()\n    diagnoses = new Map<string, IssueDetail[]>();\n    @internalProperty()\n    latestIssue!: IssueDetail;\n\n    @query('#log') logUI!: Dialog;\n    @query('#diagnostic') diagnosticUI!: Dialog;\n    @query('#error') errorUI!: Snackbar;\n    @query('#warning') warningUI!: Snackbar;\n    @query('#info') infoUI!: Snackbar;\n    @query('#issue') issueUI!: Snackbar;\n\n    get canUndo(): boolean {\n      return this.currentAction >= 0;\n    }\n    get canRedo(): boolean {\n      return this.nextAction >= 0;\n    }\n\n    get previousAction(): number {\n      if (!this.canUndo) return -1;\n      return this.history\n        .slice(0, this.currentAction)\n        .map(entry => (entry.kind == 'action' ? true : false))\n        .lastIndexOf(true);\n    }\n    get nextAction(): number {\n      let index = this.history\n        .slice(this.currentAction + 1)\n        .findIndex(entry => entry.kind == 'action');\n      if (index >= 0) index += this.currentAction + 1;\n      return index;\n    }\n\n    private convertToDate(when: string | null): Date | null {\n      const convertedTime = new Date(when ?? '');\n      if (!isNaN(convertedTime.getTime())) {\n        return convertedTime;\n      }\n      return null;\n    }\n\n    private createMessage(\n      who: string | null,\n      why: string | null\n    ): string | undefined {\n      let message = who;\n      if (message !== null && why !== null) {\n        message += ' : ' + why;\n      } else if (why !== null) {\n        message = why;\n      }\n      return message ?? undefined;\n    }\n\n    private createSclHistoryEntry(\n      who: string | null,\n      what: string | null,\n      why: string | null,\n      when: string | null\n    ): SclhistoryEntry {\n      return {\n        kind: 'sclhistory',\n        title: what ?? 'UNDEFINED',\n        message: this.createMessage(who, why),\n        time: this.convertToDate(when),\n      };\n    }\n\n    private async onLoadHistoryFromDoc(event: OpenDocEvent) {\n      const doc = event.detail.doc;\n\n      Array.from(\n        doc.querySelectorAll(':root > Header > History > Hitem')\n      ).forEach(historyItem => {\n        this.history.push(\n          this.createSclHistoryEntry(\n            historyItem.getAttribute('who'),\n            historyItem.getAttribute('what'),\n            historyItem.getAttribute('why'),\n            historyItem.getAttribute('when')\n          )\n        );\n      });\n    }\n\n    private onIssue(de: IssueEvent): void {\n      const issues = this.diagnoses.get(de.detail.validatorId);\n\n      if (!issues) this.diagnoses.set(de.detail.validatorId, [de.detail]);\n      else issues?.push(de.detail);\n\n      this.latestIssue = de.detail;\n      this.issueUI.close();\n      this.issueUI.show();\n    }\n\n    undo(): boolean {\n      if (!this.canUndo) return false;\n      this.dispatchEvent(\n        newActionEvent(\n          invert((<CommitEntry>this.history[this.currentAction]).action)\n        )\n      );\n      this.currentAction = this.previousAction;\n      return true;\n    }\n    redo(): boolean {\n      if (!this.canRedo) return false;\n      this.dispatchEvent(\n        newActionEvent((<CommitEntry>this.history[this.nextAction]).action)\n      );\n      this.currentAction = this.nextAction;\n      return true;\n    }\n\n    private onLog(le: LogEvent): void {\n      if (le.detail.kind === 'reset') {\n        this.history = [];\n        this.currentAction = -1;\n        return;\n      }\n\n      const entry: LogEntry = {\n        time: new Date(),\n        ...le.detail,\n      };\n\n      if (entry.kind === 'action') {\n        if (entry.action.derived) return;\n        entry.action.derived = true;\n        if (this.nextAction !== -1) this.history.splice(this.nextAction);\n        this.currentAction = this.history.length;\n      }\n\n      this.history.push(entry);\n      if (!this.logUI.open) {\n        const ui = {\n          error: this.errorUI,\n          warning: this.warningUI,\n          info: this.infoUI,\n          action: this.infoUI,\n        }[le.detail.kind];\n\n        ui.close();\n        ui.show();\n      }\n      if (le.detail.kind == 'error') {\n        this.errorUI.close(); // hack to reset timeout\n        this.errorUI.show();\n      }\n      this.requestUpdate('history', []);\n    }\n\n    async performUpdate() {\n      await new Promise<void>(resolve =>\n        requestAnimationFrame(() => resolve())\n      );\n      super.performUpdate();\n    }\n\n    constructor(...args: any[]) {\n      super(...args);\n\n      this.undo = this.undo.bind(this);\n      this.redo = this.redo.bind(this);\n\n      this.onLog = this.onLog.bind(this);\n      this.addEventListener('log', this.onLog);\n      this.addEventListener('issue', this.onIssue);\n      this.addEventListener('open-doc', this.onLoadHistoryFromDoc);\n    }\n\n    renderLogEntry(\n      entry: LogEntry,\n      index: number,\n      history: LogEntry[]\n    ): TemplateResult {\n      return html` <abbr title=\"${entry.title}\">\n        <mwc-list-item\n          class=\"${entry.kind}\"\n          graphic=\"icon\"\n          ?twoline=${!!entry.message}\n          ?activated=${this.currentAction == history.length - index - 1}\n        >\n          <span>\n            <!-- FIXME: replace tt with mwc-chip asap -->\n            <tt>${entry.time?.toLocaleString()}</tt>\n            ${entry.title}</span\n          >\n          <span slot=\"secondary\">${entry.message}</span>\n          <mwc-icon\n            slot=\"graphic\"\n            style=\"--mdc-theme-text-icon-on-background:var(${ifDefined(\n              iconColors[entry.kind]\n            )})\"\n            >${icons[entry.kind]}</mwc-icon\n          >\n        </mwc-list-item></abbr\n      >`;\n    }\n\n    private renderHistory(): TemplateResult[] | TemplateResult {\n      if (this.history.length > 0)\n        return this.history.slice().reverse().map(this.renderLogEntry, this);\n      else\n        return html`<mwc-list-item disabled graphic=\"icon\">\n          <span>${translate('log.placeholder')}</span>\n          <mwc-icon slot=\"graphic\">info</mwc-icon>\n        </mwc-list-item>`;\n    }\n\n    private renderIssueEntry(issue: IssueDetail): TemplateResult {\n      return html` <abbr title=\"${issue.title + '\\n' + issue.message}\"\n        ><mwc-list-item ?twoline=${!!issue.message}>\n          <span> ${issue.title}</span>\n          <span slot=\"secondary\">${issue.message}</span>\n        </mwc-list-item></abbr\n      >`;\n    }\n\n    renderValidatorsIssues(issues: IssueDetail[]): TemplateResult[] {\n      if (issues.length === 0) return [html``];\n      return [\n        html`<mwc-list-item noninteractive\n          >${getPluginName(issues[0].validatorId)}</mwc-list-item\n        >`,\n        html`<li divider padded role=\"separator\"></li>`,\n        ...issues.map(issue => this.renderIssueEntry(issue)),\n      ];\n    }\n\n    private renderIssues(): TemplateResult[] | TemplateResult {\n      const issueItems: TemplateResult[] = [];\n\n      this.diagnoses.forEach(issues => {\n        this.renderValidatorsIssues(issues).forEach(issueItem =>\n          issueItems.push(issueItem)\n        );\n      });\n\n      return issueItems.length\n        ? issueItems\n        : html`<mwc-list-item disabled graphic=\"icon\">\n            <span>${translate('diag.placeholder')}</span>\n            <mwc-icon slot=\"graphic\">info</mwc-icon>\n          </mwc-list-item>`;\n    }\n\n    private renderFilterButtons() {\n      return (<LogEntryType[]>Object.keys(icons)).map(\n        kind => html`<mwc-icon-button-toggle\n          id=\"${kind}filter\"\n          ?on=${kind !== 'sclhistory'}\n          >${getFilterIcon(kind, false)}\n          ${getFilterIcon(kind, true)}</mwc-icon-button-toggle\n        >`\n      );\n    }\n\n    render(): TemplateResult {\n      return html`${ifImplemented(super.render())}\n        <style>\n          #log > mwc-icon-button-toggle {\n            position: absolute;\n            top: 8px;\n            right: 14px;\n          }\n          #log > mwc-icon-button-toggle:nth-child(2) {\n            right: 62px;\n          }\n          #log > mwc-icon-button-toggle:nth-child(3) {\n            right: 110px;\n          }\n          #log > mwc-icon-button-toggle:nth-child(4) {\n            right: 158px;\n          }\n          #log > mwc-icon-button-toggle:nth-child(5) {\n            right: 206px;\n          }\n          #content mwc-list-item.info,\n          #content mwc-list-item.warning,\n          #content mwc-list-item.error,\n          #content mwc-list-item.action,\n          #content mwc-list-item.sclhistory {\n            display: none;\n          }\n          #infofilter[on] ~ #content mwc-list-item.info {\n            display: flex;\n          }\n          #warningfilter[on] ~ #content mwc-list-item.warning {\n            display: flex;\n          }\n          #errorfilter[on] ~ #content mwc-list-item.error {\n            display: flex;\n          }\n          #actionfilter[on] ~ #content mwc-list-item.action {\n            display: flex;\n          }\n          #sclhistoryfilter[on] ~ #content mwc-list-item.sclhistory {\n            display: flex;\n          }\n\n          #log {\n            --mdc-dialog-min-width: 92vw;\n          }\n\n          #log > #filterContainer {\n            position: absolute;\n            top: 14px;\n            right: 14px;\n          }\n        </style>\n        <mwc-dialog id=\"log\" heading=\"${translate('log.name')}\">\n          ${this.renderFilterButtons()}\n          <mwc-list id=\"content\" wrapFocus>${this.renderHistory()}</mwc-list>\n          <mwc-button\n            icon=\"undo\"\n            label=\"${translate('undo')}\"\n            ?disabled=${!this.canUndo}\n            @click=${this.undo}\n            slot=\"secondaryAction\"\n          ></mwc-button>\n          <mwc-button\n            icon=\"redo\"\n            label=\"${translate('redo')}\"\n            ?disabled=${!this.canRedo}\n            @click=${this.redo}\n            slot=\"secondaryAction\"\n          ></mwc-button>\n          <mwc-button slot=\"primaryAction\" dialogaction=\"close\"\n            >${translate('close')}</mwc-button\n          >\n        </mwc-dialog>\n\n        <mwc-dialog id=\"diagnostic\" heading=\"${translate('diag.name')}\">\n          <filtered-list id=\"content\" wrapFocus\n            >${this.renderIssues()}</filtered-list\n          >\n          <mwc-button slot=\"primaryAction\" dialogaction=\"close\"\n            >${translate('close')}</mwc-button\n          >\n        </mwc-dialog>\n\n        <mwc-snackbar\n          id=\"info\"\n          timeoutMs=\"4000\"\n          labelText=\"${this.history\n            .slice()\n            .reverse()\n            .find(le => le.kind === 'info' || le.kind === 'action')?.title ??\n          get('log.snackbar.placeholder')}\"\n        >\n          <mwc-icon-button icon=\"close\" slot=\"dismiss\"></mwc-icon-button>\n        </mwc-snackbar>\n        <mwc-snackbar\n          id=\"warning\"\n          timeoutMs=\"6000\"\n          labelText=\"${this.history\n            .slice()\n            .reverse()\n            .find(le => le.kind === 'warning')?.title ??\n          get('log.snackbar.placeholder')}\"\n        >\n          <mwc-button\n            slot=\"action\"\n            icon=\"history\"\n            @click=${() => this.logUI.show()}\n            >${translate('log.snackbar.show')}</mwc-button\n          >\n          <mwc-icon-button icon=\"close\" slot=\"dismiss\"></mwc-icon-button>\n        </mwc-snackbar>\n        <mwc-snackbar\n          id=\"error\"\n          timeoutMs=\"10000\"\n          labelText=\"${this.history\n            .slice()\n            .reverse()\n            .find(le => le.kind === 'error')?.title ??\n          get('log.snackbar.placeholder')}\"\n        >\n          <mwc-button\n            slot=\"action\"\n            icon=\"history\"\n            @click=${() => this.logUI.show()}\n            >${translate('log.snackbar.show')}</mwc-button\n          >\n          <mwc-icon-button icon=\"close\" slot=\"dismiss\"></mwc-icon-button>\n        </mwc-snackbar>\n        <mwc-snackbar\n          id=\"issue\"\n          timeoutMs=\"10000\"\n          labelText=\"${this.latestIssue?.title ??\n          get('log.snackbar.placeholder')}\"\n        >\n          <mwc-button\n            slot=\"action\"\n            icon=\"rule\"\n            @click=${() => this.diagnosticUI.show()}\n            >${translate('log.snackbar.show')}</mwc-button\n          >\n          <mwc-icon-button icon=\"close\" slot=\"dismiss\"></mwc-icon-button>\n        </mwc-snackbar>`;\n    }\n  }\n\n  return LoggingElement;\n}\n"]}