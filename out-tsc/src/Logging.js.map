{"version":3,"file":"Logging.js","sourceRoot":"","sources":["../../src/Logging.ts"],"names":[],"mappings":"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","sourcesContent":["import { css, html, property, query, TemplateResult } from 'lit-element';\nimport { ifDefined } from 'lit-html/directives/if-defined';\n\nimport '@material/mwc-button';\nimport '@material/mwc-dialog';\nimport '@material/mwc-icon';\nimport '@material/mwc-icon-button';\nimport '@material/mwc-list';\nimport '@material/mwc-list/mwc-list-item';\nimport '@material/mwc-snackbar';\nimport { Dialog } from '@material/mwc-dialog';\nimport { Snackbar } from '@material/mwc-snackbar';\n\nimport {\n  CommitEntry,\n  ifImplemented,\n  invert,\n  LitElementConstructor,\n  LogEntry,\n  LogEvent,\n  Mixin,\n  newActionEvent,\n} from './foundation.js';\nimport { get, translate } from 'lit-translate';\nconst icons = {\n  info: 'info',\n  warning: 'warning',\n  error: 'report',\n  action: 'history',\n};\n\nconst colors = {\n  info: '--cyan',\n  warning: '--yellow',\n  error: '--red',\n  action: undefined,\n};\n\nexport type LoggingElement = Mixin<typeof Logging>;\n\nexport function Logging<TBase extends LitElementConstructor>(Base: TBase) {\n  class LoggingElement extends Base {\n    @property()\n    history: LogEntry[] = [];\n    @query('#log') logUI!: Dialog;\n    @query('#message') messageUI!: Snackbar;\n\n    currentAction = -1;\n\n    get canUndo(): boolean {\n      return this.currentAction >= 0;\n    }\n    get canRedo(): boolean {\n      return this.nextAction >= 0;\n    }\n    get previousAction(): number {\n      if (!this.canUndo) return -1;\n      return this.history\n        .slice(0, this.currentAction)\n        .map(entry => (entry.kind == 'action' ? true : false))\n        .lastIndexOf(true);\n    }\n    get nextAction(): number {\n      let index = this.history\n        .slice(this.currentAction + 1)\n        .findIndex(entry => entry.kind == 'action');\n      if (index >= 0) index += this.currentAction + 1;\n      return index;\n    }\n\n    undo(): boolean {\n      if (!this.canUndo) return false;\n      this.dispatchEvent(\n        newActionEvent(\n          invert((<CommitEntry>this.history[this.currentAction]).action)\n        )\n      );\n      this.currentAction = this.previousAction;\n      return true;\n    }\n\n    redo(): boolean {\n      if (!this.canRedo) return false;\n      this.dispatchEvent(\n        newActionEvent((<CommitEntry>this.history[this.nextAction]).action)\n      );\n      this.currentAction = this.nextAction;\n      return true;\n    }\n\n    reset(): void {\n      this.history = [];\n      this.currentAction = -1;\n    }\n\n    onLog(le: LogEvent): void {\n      const entry: LogEntry = {\n        time: new Date(),\n        ...le.detail,\n      };\n      if (entry.kind == 'action') {\n        if (entry.action.derived) return;\n        entry.action.derived = true;\n        if (this.nextAction !== -1) this.history.splice(this.nextAction);\n        this.currentAction = this.history.length;\n      }\n      this.history.push(entry);\n      if (le.detail.kind == 'error') this.messageUI.show();\n    }\n\n    constructor(...args: any[]) {\n      super(...args);\n\n      this.undo = this.undo.bind(this);\n      this.redo = this.redo.bind(this);\n\n      this.onLog = this.onLog.bind(this);\n      this.addEventListener('log', this.onLog);\n    }\n\n    renderLogEntry(\n      entry: LogEntry,\n      index: number,\n      history: LogEntry[]\n    ): TemplateResult {\n      return html`<mwc-list-item\n        graphic=\"icon\"\n        style=\"--mdc-theme-text-icon-on-background:var(${ifDefined(\n          colors[entry.kind]\n        )})\"\n        ?twoline=${entry.message}\n        ?activated=${this.currentAction == history.length - index - 1}\n      >\n        <span>\n          <!-- FIXME: replace tt with mwc-chip asap -->\n          <tt>${entry.time.toLocaleTimeString()}</tt>\n          ${entry.title}</span\n        >\n        <span slot=\"secondary\">${entry.message}</span>\n        <mwc-icon slot=\"graphic\">${icons[entry.kind]}</mwc-icon>\n      </mwc-list-item>`;\n    }\n\n    renderHistory(): TemplateResult[] | TemplateResult {\n      if (this.history.length > 0)\n        return this.history.slice().reverse().map(this.renderLogEntry, this);\n      else\n        return html`<mwc-list-item disabled graphic=\"icon\">\n          <span>${translate('log.placeholder')}</span>\n          <mwc-icon slot=\"graphic\">info</mwc-icon>\n        </mwc-list-item>`;\n    }\n\n    render(): TemplateResult {\n      return html`${ifImplemented(super.render())}\n        <mwc-dialog id=\"log\" heading=\"${translate('log.name')}\">\n          <mwc-list id=\"content\" wrapFocus>${this.renderHistory()}</mwc-list>\n          <mwc-button\n            icon=\"undo\"\n            label=\"${translate('undo')}\"\n            ?disabled=${!this.canUndo}\n            @click=${this.undo}\n            slot=\"secondaryAction\"\n          ></mwc-button>\n          <mwc-button\n            icon=\"redo\"\n            label=\"${translate('redo')}\"\n            ?disabled=${!this.canRedo}\n            @click=${this.redo}\n            slot=\"secondaryAction\"\n          ></mwc-button>\n          <mwc-button slot=\"primaryAction\" dialogaction=\"close\"\n            >${translate('close')}</mwc-button\n          >\n        </mwc-dialog>\n\n        <mwc-snackbar\n          id=\"message\"\n          timeoutMs=\"-1\"\n          labelText=\"${this.history\n            .slice()\n            .reverse()\n            .find(le => le.kind == 'error')?.title ??\n          get('log.snackbar.placeholder')}\"\n        >\n          <mwc-button\n            slot=\"action\"\n            icon=\"rule\"\n            @click=${() => this.logUI.show()}\n            >${translate('log.snackbar.show')}</mwc-button\n          >\n          <mwc-icon-button icon=\"close\" slot=\"dismiss\"></mwc-icon-button>\n        </mwc-snackbar>`;\n    }\n  }\n\n  return LoggingElement;\n}\n"]}