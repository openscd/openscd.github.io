{"version":3,"file":"foundation.js","sourceRoot":"","sources":["../../../../src/editors/substation/foundation.ts"],"names":[],"mappings":"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","sourcesContent":["import { css } from 'lit-element';\n\nimport {\n  EditorAction,\n  getValue,\n  newActionEvent,\n  WizardActor,\n  WizardInput,\n} from '../../foundation.js';\nimport { VoltageLevelEditor } from './voltage-level-editor.js';\nimport { BayEditor } from './bay-editor.js';\n\nexport type ElementEditor = Element & {\n  element: Element;\n};\n\ninterface UpdateOptions {\n  element: Element;\n}\ninterface CreateOptions {\n  parent: Element;\n}\nexport type WizardOptions = UpdateOptions | CreateOptions;\n\nexport function isCreateOptions(\n  options: WizardOptions\n): options is CreateOptions {\n  return (<CreateOptions>options).parent !== undefined;\n}\n\nexport function updateNamingAction(element: Element): WizardActor {\n  return (inputs: WizardInput[]): EditorAction[] => {\n    const name = getValue(inputs.find(i => i.label === 'name')!)!;\n    const desc = getValue(inputs.find(i => i.label === 'desc')!);\n\n    if (\n      name === element.getAttribute('name') &&\n      desc === element.getAttribute('desc')\n    )\n      return [];\n\n    const newElement = <Element>element.cloneNode(false);\n    newElement.setAttribute('name', name);\n    if (desc === null) newElement.removeAttribute('desc');\n    else newElement.setAttribute('desc', desc);\n\n    return [{ old: { element }, new: { element: newElement } }];\n  };\n}\n\nexport function cloneElement(editor: BayEditor | VoltageLevelEditor): void {\n  const element: Element = editor.element;\n  const parent: Element = element.parentElement!;\n  const num = parent.querySelectorAll(\n    `${element.tagName}[name^=\"${element.getAttribute('name') ?? ''}\"]`\n  ).length;\n\n  const clone: Element = <Element>element.cloneNode(true);\n  clone\n    .querySelectorAll('LNode')\n    .forEach(lNode => lNode.parentElement?.removeChild(lNode));\n  // lNode element must be unique within substation -> must be removed\n\n  clone\n    .querySelectorAll('Terminal:not([cNodeName=\"grounded\"])')\n    .forEach(terminal => terminal.parentElement?.removeChild(terminal));\n  // FIXME(JakobVogelsang): for the moment removes terminal as well.\n  // For later terminal keep might be the better choice\n\n  clone\n    .querySelectorAll('ConnectivityNode')\n    .forEach(condNode => condNode.parentElement?.removeChild(condNode));\n  // FIXME(JakobVogelsang): for the moment beeing connectivity node remove as well.\n  // For later connectivity keep might be the better choice to preserve substation structure\n\n  clone.setAttribute('name', element.getAttribute('name')! + num);\n\n  editor.dispatchEvent(\n    newActionEvent({\n      new: {\n        parent: parent,\n        element: clone,\n        reference: element.nextElementSibling,\n      },\n    })\n  );\n}\n\n/**\n * Moves the element edited by `editor` to the place before the next `Child`\n * editor selected or to the end of the next `Parent` editor selected by mouse\n * click or keyboard (space or enter key).\n *\n * The move action can be aborted by clicking on something other than a `Child`\n * or `Parent` editor or by hitting the escape key on the keyboard.\n */\nexport function startMove<E extends ElementEditor, P extends ElementEditor>(\n  editor: E,\n  Child: new () => E,\n  Parent: new () => P\n): void {\n  if (!editor.element) return;\n\n  editor.classList.add('moving');\n\n  const moveToTarget = (e: MouseEvent | KeyboardEvent) => {\n    if (\n      e instanceof KeyboardEvent &&\n      e.key !== 'Escape' &&\n      e.key !== ' ' &&\n      e.key !== 'Enter'\n    )\n      return;\n\n    e.preventDefault();\n    e.stopImmediatePropagation();\n    editor.classList.remove('moving');\n\n    window.removeEventListener('keydown', moveToTarget, true);\n    window.removeEventListener('click', moveToTarget, true);\n\n    if (e instanceof KeyboardEvent && e.key === 'Escape') return;\n\n    const targetEditor = e\n      .composedPath()\n      .find(e => e instanceof Child || e instanceof Parent);\n\n    if (targetEditor === undefined || targetEditor === editor) return;\n\n    const destination =\n      targetEditor instanceof Child\n        ? {\n            parent: targetEditor.element.parentElement!,\n            reference: targetEditor.element,\n          }\n        : { parent: (<P>targetEditor).element, reference: null };\n\n    if (!destination.parent) return;\n\n    if (\n      editor.element.parentElement !== destination.parent ||\n      editor.element.nextElementSibling !== destination.reference\n    )\n      editor.dispatchEvent(\n        newActionEvent({\n          old: {\n            element: editor.element,\n            parent: editor.element.parentElement!,\n            reference: editor.element.nextElementSibling,\n          },\n          new: destination,\n        })\n      );\n  };\n\n  window.addEventListener('click', moveToTarget, true);\n  window.addEventListener('keydown', moveToTarget, true);\n}\n\n// Substation element hierarchy\nconst substationPath = [\n  ':root',\n  'Substation',\n  'VoltageLevel',\n  'Bay',\n  'ConductingEquipment',\n];\n\nexport type SubstationTag =\n  | 'Substation'\n  | 'VoltageLevel'\n  | 'Bay'\n  | 'ConductingEquipment';\n\n/** `Private`-safeguarded selectors for `Substation` and its descendants */\nexport const selectors = <Record<SubstationTag, string>>(\n  Object.fromEntries(\n    substationPath.map((e, i, a) => [e, a.slice(0, i + 1).join(' > ')])\n  )\n);\n\n/** Common `CSS` styles used by substation subeditors */\nexport const styles = css`\n  :host(.moving) section {\n    opacity: 0.3;\n  }\n\n  section {\n    background-color: var(--mdc-theme-surface);\n    transition: all 200ms linear;\n    outline-color: var(--mdc-theme-primary);\n    outline-style: solid;\n    outline-width: 0px;\n    margin: 8px 12px 16px;\n    opacity: 1;\n  }\n\n  section:focus {\n    box-shadow: 0 8px 10px 1px rgba(0, 0, 0, 0.14),\n      0 3px 14px 2px rgba(0, 0, 0, 0.12), 0 5px 5px -3px rgba(0, 0, 0, 0.2);\n  }\n\n  section:focus-within {\n    outline-width: 2px;\n    transition: all 250ms linear;\n  }\n\n  h1,\n  h2,\n  h3 {\n    color: var(--mdc-theme-on-surface);\n    font-family: 'Roboto', sans-serif;\n    font-weight: 300;\n    overflow: hidden;\n    white-space: nowrap;\n    text-overflow: ellipsis;\n    margin: 0px;\n    line-height: 48px;\n    padding-left: 0.3em;\n    transition: background-color 150ms linear;\n  }\n\n  section:focus-within > h1,\n  section:focus-within > h2,\n  section:focus-within > h3 {\n    color: var(--mdc-theme-surface);\n    background-color: var(--mdc-theme-primary);\n    transition: background-color 200ms linear;\n  }\n\n  h1 > nav,\n  h2 > nav,\n  h3 > nav,\n  h1 > abbr > mwc-icon-button,\n  h2 > abbr > mwc-icon-button,\n  h3 > abbr > mwc-icon-button {\n    float: right;\n  }\n\n  abbr {\n    text-decoration: none;\n    border-bottom: none;\n  }\n`;\n"]}